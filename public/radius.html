<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Radius (VM)</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { display: none; }
        
        /* CORRE√á√ÉO DO LAYOUT DA TABELA */
        
        /* O input de senha deve parecer texto comum */
        .table-input-password {
            background: transparent !important; /* Remove fundo branco */
            border: none !important;            /* Remove borda */
            box-shadow: none !important;        /* Remove sombras */
            outline: none !important;           /* Remove contorno ao clicar */
            padding: 0;
            margin: 0;
            font-family: monospace; /* Fonte fixa para as bolinhas ficarem alinhadas */
            font-size: 1rem;
            color: #333;
            width: 135px; /* Largura fixa para n√£o empurrar a tabela */
            cursor: text;
        }

        /* Bot√£o do olho (SVG) */
        .btn-eye {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555; /* Cor cinza escuro/preto */
            transition: color 0.2s;
        }
        .btn-eye:hover {
            color: #000;
        }
        
        /* Alinhamento da c√©lula de senha */
        .cell-password {
            display: flex;
            align-items: center;
            gap: 5px; /* Espa√ßo entre a senha e o olho */
        }
    </style>
</head>
<body>

    <div class="card admin-mode" style="margin-top: 20px;">
        
        <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <h2>üì° Gest√£o Radius</h2>
            <p style="color:#666; font-size: 0.9rem;">Gerenciamento da tabela <b>users</b> e <b>setor_acesso</b></p>
        </div>

        <form id="radiusForm" class="admin-form-grid" style="align-items: flex-end; grid-template-columns: 1fr 1fr 1fr 1fr auto;">
            <div>
                <label>Usu√°rio</label>
                <input type="text" id="r_username" placeholder="Ex: adalberto.piripimpim" required>
            </div>
            
            <div style="position: relative;">
                <label>Senha</label>
                <input type="password" id="r_password" placeholder="Senha" required style="padding-right: 15px;">
                <button type="button" onclick="toggleFormPassword()" class="btn-eye" style="position: absolute; right: 5px; bottom: 5px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 12.332 10.119 13.5 8 13.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                        <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5z"/>
                    </svg>
                </button>
            </div>
            
            <div>
                <label>Setor (Prio. 1)</label>
                <select id="r_setor" required>
                    <option value="" disabled selected>Carregando...</option>
                </select>
            </div>

            <div>
                <label>Acesso (Prio. 2)</label>
                <select id="r_acesso" required>
                    <option value="" disabled selected>Carregando...</option>
                </select>
            </div>
            
            <button type="submit" class="btn-success" style="height: 42px; margin-bottom: 2px;">
                <span id="btnText">Criar</span>
            </button>
        </form>

        <div class="table-responsive">
            <table id="radiusTable">
                <thead>
                    <tr>
                        <th>Usu√°rio</th>
                        <th>Senha</th>
                        <th>Setor (P1)</th>
                        <th>Acesso (P2)</th>
                        <th style="width: 100px;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" align="center">Carregando dados da VM...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="navbar.js"></script>

    <script>
        const token = localStorage.getItem('token');
        const myRole = localStorage.getItem('userRole'); 
        const mySector = localStorage.getItem('userSector'); 
        let editingUsername = null;

        // SEGURAN√áA
        if (!token) { 
            window.location.href = 'login.html'; 
        }
        else if ((myRole !== 'ADMIN_MASTER' && myRole !== 'FULL') || mySector !== 'SUPORTE_N2') {
            alert("‚õî Acesso Negado!\nExclusivo para Gestores do SUPORTE_N2.");
            window.location.href = 'menu.html';
        }
        else {
            document.body.style.display = 'flex';
            criarNavbar('Gest√£o Radius');
            carregarListasDropdown(); 
            carregarRadius();
        }

        // --- TOGGLE SENHA FORMUL√ÅRIO ---
        function toggleFormPassword() {
            const input = document.getElementById('r_password');
            input.type = input.type === "password" ? "text" : "password";
        }

        // --- TOGGLE SENHA TABELA ---
        function toggleTablePassword(id) {
            const input = document.getElementById(id);
            input.type = input.type === "password" ? "text" : "password";
        }

        // --- CARREGAR OP√á√ïES ---
        async function carregarListasDropdown() {
            try {
                const res = await fetch('/api/radius/options', { headers: { 'Authorization': `Bearer ${token}` } });
                
                if (res.ok) {
                    const dados = await res.json();
                    
                    const selSetor = document.getElementById('r_setor');
                    const selAcesso = document.getElementById('r_acesso');
                    
                    selSetor.innerHTML = '<option value="" disabled selected>Selecione Setor</option>';
                    selAcesso.innerHTML = '<option value="" disabled selected>Selecione Acesso</option>';

                    dados.setores.forEach(item => {
                        selSetor.innerHTML += `<option value="${item.groupname}">${item.groupname}</option>`;
                    });

                    dados.acessos.forEach(item => {
                        selAcesso.innerHTML += `<option value="${item.groupname}">${item.groupname}</option>`;
                    });
                }
            } catch (err) { console.error("Erro ao carregar selects", err); }
        }

        // --- LISTAR USU√ÅRIOS ---
        async function carregarRadius() {
            try {
                const res = await fetch('/api/radius/users', { headers: { 'Authorization': `Bearer ${token}` } });
                const users = await res.json();
                const tbody = document.querySelector('#radiusTable tbody');
                tbody.innerHTML = '';

                if(users.error) {
                    tbody.innerHTML = `<tr><td colspan="5" align="center" style="color:red">Erro: ${users.error}</td></tr>`;
                    return;
                }
                if(users.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" align="center">Vazio.</td></tr>`;
                    return;
                }

                users.forEach((u, index) => {
                    const passId = `pass_field_${index}`;
                    
                    // √çcone de Olho (SVG) - C√≥digo otimizado
                    const eyeIcon = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 12.332 10.119 13.5 8 13.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5z"/>
                        </svg>
                    `;

                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${u.username}</strong></td>
                            
                            <td>
                                <div class="cell-password">
                                    <input type="password" id="${passId}" value="${u.password}" class="table-input-password" readonly>
                                    <button class="btn-eye" onclick="toggleTablePassword('${passId}')" title="Ver Senha">
                                        ${eyeIcon}
                                    </button>
                                </div>
                            </td>

                            <td><span class="tag-badge" style="background:#e8f8f5; color:#27ae60;">${u.setor || '-'}</span></td>
                            <td><span class="tag-badge" style="background:#fef9e7; color:#f1c40f;">${u.acesso || '-'}</span></td>
                            <td>
                                <button class="action-btn btn-edit" onclick="prepararEdicao('${u.username}', '${u.password}', '${u.setor}', '${u.acesso}')">‚úèÔ∏è</button>
                                <button class="action-btn btn-del" onclick="excluirRadius('${u.username}')">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            } catch(e) {
                document.querySelector('#radiusTable tbody').innerHTML = `<tr><td colspan="5" align="center" style="color:red">Falha na conex√£o com a VM.</td></tr>`;
            }
        }

        // --- ENVIAR FORMUL√ÅRIO (CRIAR/EDITAR) ---
        document.getElementById('radiusForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                username: document.getElementById('r_username').value,
                password: document.getElementById('r_password').value,
                setor: document.getElementById('r_setor').value,
                acesso: document.getElementById('r_acesso').value
            };

            let url = '/api/radius/users';
            let method = 'POST';

            if (editingUsername) {
                url = `/api/radius/users/${editingUsername}`;
                method = 'PUT';
            }

            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(data)
            });

            const result = await res.json();
            
            if (res.ok) {
                alert(result.message);
                limparForm();
                carregarRadius();
            } else {
                alert("Erro: " + result.error);
            }
        });

        // --- PREPARAR EDI√á√ÉO ---
        function prepararEdicao(user, pass, setor, acesso) {
            editingUsername = user;
            document.getElementById('r_username').value = user;
            document.getElementById('r_username').disabled = true; 
            document.getElementById('r_password').value = pass;
            
            // Revela a senha ao editar
            document.getElementById('r_password').type = "text"; 

            if(setor && setor !== 'null') document.getElementById('r_setor').value = setor;
            if(acesso && acesso !== 'null') document.getElementById('r_acesso').value = acesso;
            
            document.getElementById('btnText').innerText = "Salvar";
            document.querySelector('.btn-success').style.background = "#e67e22";
        }

        function limparForm() {
            editingUsername = null;
            document.getElementById('radiusForm').reset();
            document.getElementById('r_username').disabled = false;
            document.getElementById('r_password').type = "password"; 
            document.getElementById('btnText').innerText = "Criar";
            document.querySelector('.btn-success').style.background = "";
            document.getElementById('r_setor').value = "";
            document.getElementById('r_acesso').value = "";
        }

        // --- EXCLUIR ---
        async function excluirRadius(username) {
            if(!confirm(`Apagar ${username}?`)) return;

            const res = await fetch(`/api/radius/users/${username}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.ok) {
                alert("Removido!");
                carregarRadius();
            } else {
                alert("Erro ao excluir.");
            }
        }
    </script>
</body>
</html>