<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Usu√°rios</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { display: none; }
        
        /* Layout das Configura√ß√µes */
        .admin-controls { 
            display: none; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-bottom: 30px; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 20px; 
        }

        .config-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .config-title { font-size: 1.1rem; font-weight: bold; color: #2c3e50; margin-bottom: 5px; border-bottom: 1px solid #ddd; padding-bottom: 5px;}

        /* Listas Visuais */
        .item-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            background: white;
            border-radius: 4px;
            margin-top: 10px;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #f1f1f1;
            font-size: 0.9rem;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item span { font-weight: 500; color: #555; }
        
        /* Bot√µes de A√ß√£o */
        .action-btn { cursor: pointer; border: none; background: none; font-size: 1rem; padding: 2px 5px; transition: 0.2s; }
        .action-btn:hover { transform: scale(1.2); }
        .btn-del { color: #e74c3c; } /* Vermelho */
        .btn-edit { color: #3498db; } /* Azul */

        .tag-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; background: white; }
    </style>
</head>

<body>

    <div class="card admin-mode" style="margin-top: 20px;">

        <div id="masterControls" class="admin-controls">
            
            <div class="config-card">
                <div class="config-title">üè¢ Gest√£o de Setores</div>
                <div style="display:flex; gap:5px;">
                    <input type="hidden" id="sectorIdEdit">
                    <input type="text" id="newSectorName" placeholder="Nome (Ex: FINANCEIRO)">
                    <button class="btn-success" style="width:auto; margin:0;" onclick="salvarSetor()" id="btnSaveSector">+</button>
                    <button class="btn-danger" style="width:auto; margin:0; display:none;" onclick="cancelarEdicaoSetor()" id="btnCancelSector">‚úï</button>
                </div>
                <div class="item-list" id="listaSetores">Carregando...</div>
            </div>

            <div class="config-card">
                <div class="config-title">‚öñÔ∏è Gest√£o de Cargos</div>
                <input type="hidden" id="roleIdEdit">
                <input type="text" id="newRoleName" placeholder="Nome (Ex: SUPERVISOR)" style="margin-bottom:0;">
                <div style="display: flex; gap: 5px;">
                    <select id="newRoleLevel" style="flex:1;">
                        <option value="50">N√≠vel 50 (Ger√™ncia)</option>
                        <option value="20">N√≠vel 20 (Operacional)</option>
                        <option value="10">N√≠vel 10 (Visualiza√ß√£o)</option>
                    </select>
                    <input type="text" id="newRoleLabel" placeholder="Tag (Ex: Pode Editar)" style="flex:1;">
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="btn-success" style="margin:0;" onclick="salvarCargo()" id="btnSaveRole">Salvar Cargo</button>
                    <button class="btn-danger" style="margin:0; width: 40px; display:none;" onclick="cancelarEdicaoCargo()" id="btnCancelRole">‚úï</button>
                </div>
                <div class="item-list" id="listaCargos">Carregando...</div>
            </div>
        </div>

        <form id="createForm" class="admin-form-grid">
            <div style="grid-column: span 2;"><h3>üë§ Gerenciar Usu√°rio</h3></div>
            <div>
                <input type="text" id="name" placeholder="Nome Completo" required>
                <input type="email" id="email" placeholder="E-mail" style="margin-top: 10px;" required>
                <input type="text" id="phone" placeholder="Telefone" style="margin-top: 10px;" required>
            </div>
            <div>
                <input type="password" id="password" placeholder="Senha Inicial" required>
                <select id="role" style="margin-top: 10px;" required><option>Carregando...</option></select>
                <select id="sector" style="margin-top: 10px;" required><option>Carregando...</option></select>
            </div>
            <button type="submit" class="btn-primary" style="grid-column: span 2;">Criar Usu√°rio</button>
        </form>

        <div class="table-responsive">
            <h3>Lista de Usu√°rios</h3>
            <table id="usersTable">
                <thead><tr><th>Nome</th><th>E-mail</th><th>Cargo / Permiss√µes</th><th>Setor</th><th>A√ß√µes</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script src="navbar.js"></script>

    <script>
        let editingUserId = null;
        const token = localStorage.getItem('token');
        const myRole = localStorage.getItem('userRole');

        if (!token) { window.location.href = 'login.html'; }
        else {
            document.body.style.display = 'flex';
            criarNavbar('Gest√£o de Usu√°rios');
            iniciarPagina();
        }

        async function iniciarPagina() {
            if (myRole === 'ADMIN_MASTER') {
                document.getElementById('masterControls').style.display = 'grid';
                await atualizarListaSetores();
                await atualizarListaCargos();
            }
            await carregarOpcoesDropdown();
            await carregarUsuarios();
        }

        // --- GEST√ÉO DE SETORES ---
        async function atualizarListaSetores() {
            const res = await fetch('/api/sectors');
            const setores = await res.json();
            const divLista = document.getElementById('listaSetores');
            divLista.innerHTML = '';
            setores.forEach(s => {
                divLista.innerHTML += `
                    <div class="list-item">
                        <span>${s.name}</span>
                        <div>
                            <button class="action-btn btn-edit" onclick="prepararEdicaoSetor('${s.id}', '${s.name}')">‚úèÔ∏è</button>
                            <button class="action-btn btn-del" onclick="excluirSetor('${s.id}')">üóëÔ∏è</button>
                        </div>
                    </div>`;
            });
            carregarOpcoesDropdown();
        }

        async function salvarSetor() {
            const id = document.getElementById('sectorIdEdit').value;
            const name = document.getElementById('newSectorName').value.toUpperCase();
            if (!name) return;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/sectors/${id}` : '/api/sectors';
            const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ name }) });
            if (res.ok) { alert(id?'Setor Atualizado!':'Setor Criado!'); cancelarEdicaoSetor(); atualizarListaSetores(); }
        }

        function prepararEdicaoSetor(id, nome) {
            document.getElementById('sectorIdEdit').value = id;
            document.getElementById('newSectorName').value = nome;
            document.getElementById('btnSaveSector').innerText = "üíæ";
            document.getElementById('btnCancelSector').style.display = "inline-block";
        }
        function cancelarEdicaoSetor() {
            document.getElementById('sectorIdEdit').value = "";
            document.getElementById('newSectorName').value = "";
            document.getElementById('btnSaveSector').innerText = "+";
            document.getElementById('btnCancelSector').style.display = "none";
        }
        async function excluirSetor(id) {
            if(!confirm("Tem certeza?")) return;
            const res = await fetch(`/api/sectors/${id}`, { method: 'DELETE', headers: {'Authorization': `Bearer ${token}`} });
            if(res.ok) atualizarListaSetores(); else alert((await res.json()).error);
        }

        // --- GEST√ÉO DE CARGOS ---
        async function atualizarListaCargos() {
            const res = await fetch('/api/roles');
            const cargos = await res.json();
            const divLista = document.getElementById('listaCargos');
            divLista.innerHTML = '';
            cargos.forEach(c => {
                divLista.innerHTML += `
                    <div class="list-item">
                        <div style="display:flex; flex-direction:column;">
                            <span>${c.name} <small style="color:#999;">(Nv. ${c.level})</small></span>
                            <span class="tag-badge">${c.label}</span>
                        </div>
                        <div>
                            <button class="action-btn btn-edit" onclick="prepararEdicaoCargo('${c.id}', '${c.name}', '${c.level}', '${c.label}')">‚úèÔ∏è</button>
                            <button class="action-btn btn-del" onclick="excluirCargo('${c.id}')">üóëÔ∏è</button>
                        </div>
                    </div>`;
            });
            carregarOpcoesDropdown();
        }

        async function salvarCargo() {
            const id = document.getElementById('roleIdEdit').value;
            const name = document.getElementById('newRoleName').value.toUpperCase();
            const level = document.getElementById('newRoleLevel').value;
            const label = document.getElementById('newRoleLabel').value;
            if (!name || !label) return;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/roles/${id}` : '/api/roles';
            const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ name, level, label }) });
            if (res.ok) { alert(id?'Cargo Atualizado!':'Cargo Criado!'); cancelarEdicaoCargo(); atualizarListaCargos(); }
        }

        function prepararEdicaoCargo(id, name, level, label) {
            document.getElementById('roleIdEdit').value = id;
            document.getElementById('newRoleName').value = name;
            document.getElementById('newRoleLevel').value = level;
            document.getElementById('newRoleLabel').value = label;
            document.getElementById('btnSaveRole').innerText = "Salvar";
            document.getElementById('btnCancelRole').style.display = "inline-block";
        }
        function cancelarEdicaoCargo() {
            document.getElementById('roleIdEdit').value = "";
            document.getElementById('newRoleName').value = "";
            document.getElementById('newRoleLabel').value = "";
            document.getElementById('btnSaveRole').innerText = "Salvar Cargo";
            document.getElementById('btnCancelRole').style.display = "none";
        }
        async function excluirCargo(id) {
            if(!confirm("Tem certeza?")) return;
            const res = await fetch(`/api/roles/${id}`, { method: 'DELETE', headers: {'Authorization': `Bearer ${token}`} });
            if(res.ok) atualizarListaCargos(); else alert((await res.json()).error);
        }

        // --- GEST√ÉO DE USU√ÅRIOS ---
        async function carregarOpcoesDropdown() {
            try {
                const [rolesRes, sectorsRes] = await Promise.all([fetch('/api/roles'), fetch('/api/sectors')]);
                const roles = await rolesRes.json();
                const sectors = await sectorsRes.json();
                const roleSelect = document.getElementById('role');
                const sectorSelect = document.getElementById('sector');
                
                // Mant√©m sele√ß√£o se estiver editando
                const curRole = roleSelect.value;
                const curSector = sectorSelect.value;

                roleSelect.innerHTML = '<option value="" disabled selected>Selecione o Cargo</option>';
                roles.forEach(r => roleSelect.innerHTML += `<option value="${r.name}">${r.name} (${r.label})</option>`);
                sectorSelect.innerHTML = '<option value="" disabled selected>Selecione o Setor</option>';
                sectors.forEach(s => sectorSelect.innerHTML += `<option value="${s.name}">${s.name}</option>`);

                if(curRole) roleSelect.value = curRole;
                if(curSector) sectorSelect.value = curSector;
            } catch (err) { console.error(err); }
        }

        async function editarUsuario(id) {
            const response = await fetch(`/api/users/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
            if (response.ok) {
                const user = await response.json();
                document.getElementById('name').value = user.name;
                document.getElementById('email').value = user.email;
                document.getElementById('phone').value = user.phone;
                document.getElementById('role').value = user.role.name;
                document.getElementById('sector').value = user.sector.name;
                const pass = document.getElementById('password');
                pass.value = ""; pass.placeholder = "Vazio para manter a senha"; pass.required = false;

                editingUserId = user.id;
                const btn = document.querySelector('#createForm button[type="submit"]');
                btn.innerText = "Salvar Altera√ß√µes";
                btn.classList.replace('btn-primary', 'btn-success');
                btn.style.backgroundColor = "#e67e22";
                document.getElementById('createForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // --- NOVA FUN√á√ÉO: EXCLUIR USU√ÅRIO ---
        async function excluirUsuario(id) {
            if(!confirm("Tem certeza que deseja EXCLUIR este usu√°rio? Essa a√ß√£o n√£o pode ser desfeita.")) return;
            
            const response = await fetch(`/api/users/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                alert("Usu√°rio Exclu√≠do!");
                carregarUsuarios(); // Atualiza a tabela
            } else {
                const res = await response.json();
                alert(res.error || "Erro ao excluir");
            }
        }

        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                password: document.getElementById('password').value,
                roleName: document.getElementById('role').value,
                sectorName: document.getElementById('sector').value
            };
            const url = editingUserId ? `/api/users/${editingUserId}` : '/api/users';
            const method = editingUserId ? 'PUT' : 'POST';
            const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });

            if (response.ok) {
                alert(editingUserId ? "Atualizado!" : "Criado!");
                document.getElementById('createForm').reset();
                document.getElementById('password').placeholder = "Senha Inicial";
                document.getElementById('password').required = true;
                editingUserId = null;
                const btn = document.querySelector('#createForm button[type="submit"]');
                btn.innerText = "Criar Usu√°rio";
                btn.classList.replace('btn-success', 'btn-primary');
                btn.style.backgroundColor = "";
                carregarUsuarios();
            } else { const res = await response.json(); alert(res.error); }
        });

        async function carregarUsuarios() {
            const response = await fetch('/api/users', { headers: { 'Authorization': `Bearer ${token}` } });
            if (response.ok) {
                const users = await response.json();
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '';
                if (users.length === 0) return tbody.innerHTML = '<tr><td colspan="5" align="center">Ningu√©m encontrado.</td></tr>';

                users.forEach(user => {
                    let badgeColor = '#ecf0f1';
                    if (user.role === 'ADMIN_MASTER') badgeColor = '#fadbd8';
                    else if (user.role === 'FULL') badgeColor = '#d4efdf';
                    
                    // Adicionei o bot√£o de LIXEIRA aqui embaixo
                    tbody.innerHTML += `<tr>
                        <td>${user.name}</td><td>${user.email}</td>
                        <td><span style="padding:4px 8px; border-radius:4px; background:${badgeColor}; font-weight:bold; font-size:0.8rem;">${user.role}</span> <span class="tag-badge">${user.roleLabel || ''}</span></td>
                        <td>${user.sector}</td>
                        <td>
                            <button class="action-btn btn-edit" onclick="editarUsuario('${user.id}')" title="Editar">‚úèÔ∏è</button>
                            <button class="action-btn btn-del" onclick="excluirUsuario('${user.id}')" title="Excluir">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
            }
        }
    </script>
</body>
</html>