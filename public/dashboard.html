<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    
    <script>
        if (!localStorage.getItem('token')) {
            window.location.href = 'login.html';
        }
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Projetos</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            display: none;
            background-color: #f4f6f9;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 25px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-icon {
            width: 48px;
            height: 48px;
            background-color: #fff3cd;
            color: #d35400;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .header-text h2 {
            margin: 0;
            font-size: 1.4rem;
            color: #2c3e50;
            line-height: 1.2;
        }

        .header-text p {
            margin: 4px 0 0;
            color: #7f8c8d;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .btn-new-project {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(39, 174, 96, 0.2);
            height: 45px;
        }

        .btn-new-project:hover {
            background-color: #219150;
            transform: translateY(-1px);
        }

        .table-responsive {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border: 1px solid #ddd;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: #2c3e50;
            color: white;
        }

        th,
        td {
            padding: 14px 20px;
            text-align: left;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        td {
            color: #555;
            font-size: 0.95rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-block;
            min-width: 90px;
            text-align: center;
        }

        .status-loading {
            background-color: #e2e3e5;
            color: #383d41;
        }

        .status-online {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-offline {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .actions-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

        .action-btn {
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.1rem;
            padding: 4px;
            transition: 0.2s;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .btn-open {
            color: #f39c12;
        }

        .btn-edit {
            color: #3498db;
        }

        .btn-del {
            color: #e74c3c;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            font-size: 0.9rem;
        }

        .form-control,
        input[type="text"],
        input[type="number"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.95rem;
        }


        .provider-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .provider-row input {
            margin: 0 !important;
            font-size: 0.9rem;
        }

        .btn-remove-row {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            width: 30px;
            height: 38px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-add-row {
            background: #27ae60;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        /* Bot√µes do Modal */
        .modal-buttons {
            margin-top: 25px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .btn-cancel {
            background-color: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        .btn-cancel:hover {
            background-color: #7f8c8d;
        }

        #btnSave {
            padding: 10px 25px;
            font-size: 1rem;
        }
    </style>
</head>

<body>

    <div class="card admin-mode" style="margin-top: 20px; min-height: 80vh;">

        <div class="page-header">
            <div class="header-left">
                <div class="header-icon">üìÇ</div>
                <div class="header-text">
                    <h2>Meus Projetos</h2>
                    <p>Gerencie suas conex√µes Mikrotik</p>
                </div>
            </div>
            <button class="btn-new-project" id="btnNovoProjeto" onclick="abrirModalProjeto()" style="display: none;">
                <span>+</span> Novo Projeto
            </button>
        </div>

        <div id="loading" style="text-align:center; padding: 40px; color:#999; font-style:italic;">
            Carregando projetos...
        </div>

        <div class="table-responsive" id="tabelaContainer" style="display:none;">
            <table id="projectsTable">
                <thead>
                    <tr>
                        <th style="width: 40%;">Nome do Projeto</th>
                        <th style="width: 30%;">IP da RB</th>
                        <th style="width: 15%; text-align: center;">Status</th>
                        <th style="width: 15%; text-align: center;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="modalProject" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 650px;">
            <h3 id="modalTitle" style="margin-bottom: 15px;">‚ú® Novo Projeto</h3>

            <form id="formProject">
                <label>Nome do Projeto / Condom√≠nio</label>
                <input type="text" id="p_name" required placeholder="Ex: Condom√≠nio Jardins">

                <label>Link Excel (Opcional)</label>
                <input type="text" id="p_excel" placeholder="https://docs.google.com/spreadsheets/...">

                <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">

                <h4 style="margin-bottom:10px; color:#2c3e50;">üì° Acesso Mikrotik</h4>

                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px;">
                    <div>
                        <label>IP da RB</label>
                        <input type="text" id="p_ip" required placeholder="192.168.88.1">
                    </div>
                    <div>
                        <label title="Porta usada pelo Sistema">Porta API</label>
                        <input type="number" id="p_port" value="8728" required>
                    </div>
                    <div>
                        <label title="Porta para acesso visual">Porta Winbox</label>
                        <input type="number" id="p_winbox" value="8291" required>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>Usu√°rio</label>
                        <input type="text" id="p_user" required>
                    </div>
                    <div>
                        <label>Senha</label>
                        <div style="position:relative;">
                            <input type="password" id="p_pass" required style="margin-bottom:0;">
                            <span onclick="togglePass()"
                                style="position:absolute; right:10px; top:12px; cursor:pointer;">üëÅÔ∏è</span>
                        </div>
                    </div>
                </div>

                <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4 style="margin:0; color:#2c3e50;">üè¢ Provedoras & VLANs</h4>
                    <button type="button" class="btn-add-row" onclick="addProviderRow()">+ Adicionar</button>
                </div>

                <div id="providersContainer" style="margin-top: 10px; margin-bottom: 20px;"></div>

                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="fecharModal()">Cancelar</button>
                    <button type="submit" id="btnSave" class="btn-primary">Salvar Projeto</button>
                </div>
            </form>
        </div>
    </div>

    <script src="navbar.js"></script>

    <script>
        const token = localStorage.getItem('token');
        const userRole = localStorage.getItem('userRole');
        const userSector = localStorage.getItem('userSector');


        // --- 1. BLOQUEIO DE SEGURAN√áA IMEDIATO --- Sai fora rap√° 
        if (userSector !== 'SUPORTE_N2' && userRole !== 'ADMIN_MASTER') {
            alert("‚ö†Ô∏è Acesso Restrito: Apenas setor SUPORTE_N2.");
            window.location.href = 'menu.html';
        }

        // --- 2. PERMISS√ïES DE EDI√á√ÉO --- Meu pau no seu bund√£o
        const roleLevels = { 'ADMIN_MASTER': 100, 'FULL': 50, 'WRITE': 20, 'BEGINNER': 10 };
        const myLevel = roleLevels[userRole] || 0;
        const canManage = myLevel >= 50;

        let editingProjectId = null;
        let globalProjects = [];

        if (!token) window.location.href = 'login.html';
        else {
            document.body.style.display = 'block';
            criarNavbar('Dashboard');

            if (canManage) {
                document.getElementById('btnNovoProjeto').style.display = 'flex';
            }

            carregarProjetos();

            // Auto-refresh a cada 15 segundos - carregaaaa
            setInterval(() => {
                carregarProjetos();
            }, 15000);
        }

        function togglePass() {
            const x = document.getElementById("p_pass");
            x.type = x.type === "password" ? "text" : "password";
        }

        async function carregarProjetos() {
            try {
                const res = await fetch('/api/projects', { headers: { 'Authorization': `Bearer ${token}` } });

                if (res.status === 403) {
                    alert("Acesso Negado pelo Servidor.");
                    window.location.href = 'menu.html';
                    return;
                }

                const projects = await res.json();
                globalProjects = projects;

                const tbody = document.querySelector('#projectsTable tbody');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('tabelaContainer').style.display = 'block';

                tbody.innerHTML = '';

                if (projects.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" align="center" style="padding:40px; color:#777;">Nenhum projeto encontrado.</td></tr>';
                    return;
                }

                projects.forEach(p => {
                    const tr = document.createElement('tr');

                    let buttonsHtml = `
                        <button class="action-btn btn-open" onclick="abrirDetalhes('${p.id}', '${p.name}')" title="Abrir Dashboard">üìÇ</button>
                    `;

                    if (canManage) {
                        buttonsHtml += `
                            <button class="action-btn btn-edit" onclick="prepararEdicao('${p.id}')" title="Editar Configura√ß√µes">‚úèÔ∏è</button>
                            <button class="action-btn btn-del" onclick="excluirProjeto('${p.id}')" title="Excluir">üóëÔ∏è</button>
                        `;
                    }

                    tr.innerHTML = `
                        <td><strong style="color:#2c3e50; font-size:1rem;">${p.name}</strong></td>
                        <td style="font-family:monospace; color:#2980b9; letter-spacing:0.5px;">${p.rbIp}</td>
                        
                        <td style="text-align:center;"><span id="status-${p.id}" class="status-badge status-loading">Checando...</span></td>
                        <td>
                            <div class="actions-cell">
                                ${buttonsHtml}
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                    verificarStatus(p.id, p.rbIp);
                });

            } catch (e) { console.error(e); }
        }

        async function verificarStatus(id, ip) {
            try {
                const badge = document.getElementById(`status-${id}`);
                const res = await fetch('/api/projects/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ ip })
                });
                const data = await res.json();

                if (data.online) {
                    badge.className = 'status-badge status-online';
                    badge.innerText = `Online (${data.ms}ms)`;
                } else {
                    badge.className = 'status-badge status-offline';
                    badge.innerText = 'OFFLINE';
                }
            } catch (e) {
                const badge = document.getElementById(`status-${id}`);
                if (badge) {
                    badge.className = 'status-badge status-offline';
                    badge.innerText = 'Erro';
                }
            }
        }

        function abrirModalProjeto() {
            limparForm();
            document.getElementById('modalProject').style.display = 'flex';
            document.getElementById('p_name').focus();
        }

        function fecharModal() {
            document.getElementById('modalProject').style.display = 'none';
            limparForm();
        }

        function abrirDetalhes(id, nome) {
            window.location.href = `project-details.html?id=${id}`;
        }

        async function excluirProjeto(id) {
            if (!confirm("Tem certeza que deseja apagar este projeto?")) return;
            await fetch(`/api/projects/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            carregarProjetos();
        }

        document.getElementById('modalProject').addEventListener('click', (e) => {
            if (e.target.id === 'modalProject') fecharModal();
        });


        function addProviderRow(name = '', vlan = '', contact = '') {
            const container = document.getElementById('providersContainer');
            const div = document.createElement('div');
            div.className = 'provider-row';
            div.innerHTML = `
                <input type="text" placeholder="Nome (Ex: Vivo)" class="prov-name" value="${name}" required style="flex:2">
                <input type="text" placeholder="VLAN" class="prov-vlan" value="${vlan}" style="flex:1">
                <input type="text" placeholder="Contato (Opcional)" class="prov-contact" value="${contact}" style="flex:2">
                <button type="button" class="btn-remove-row" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(div);
        }

        function limparForm() {
            editingProjectId = null;
            document.getElementById('formProject').reset();
            document.getElementById('providersContainer').innerHTML = '';
            addProviderRow();

            document.getElementById('modalTitle').innerText = "‚ú® Novo Projeto";
            document.getElementById('btnSave').innerText = "Salvar Projeto";
            document.getElementById('p_pass').required = true;
            document.getElementById('p_port').value = "8728";
            document.getElementById('p_winbox').value = "8291";
        }

        function prepararEdicao(id) {
            const project = globalProjects.find(p => p.id === id);
            if (!project) return;

            editingProjectId = id;
            document.getElementById('modalTitle').innerText = "‚úèÔ∏è Editar Projeto";
            document.getElementById('btnSave').innerText = "Salvar Altera√ß√µes";

            document.getElementById('p_name').value = project.name;
            document.getElementById('p_excel').value = project.excelLink || '';
            document.getElementById('p_ip').value = project.rbIp;
            document.getElementById('p_user').value = project.rbUser;
            document.getElementById('p_port').value = project.rbPort || 8728;
            document.getElementById('p_winbox').value = project.rbWinboxPort || 8291; // Carrega Winbox

            const passInput = document.getElementById('p_pass');
            passInput.value = "";
            passInput.placeholder = "Deixe vazio para manter";
            passInput.required = false;

            const container = document.getElementById('providersContainer');
            container.innerHTML = '';
            if (project.providers && project.providers.length > 0) {
                project.providers.forEach(prov => {
                    addProviderRow(prov.name, prov.vlan, prov.contact || '');
                });
            } else {
                addProviderRow();
            }

            document.getElementById('modalProject').style.display = 'flex';
        }

        document.getElementById('formProject').addEventListener('submit', async (e) => {
            e.preventDefault();

            const providerRows = document.querySelectorAll('.provider-row');
            const providersList = [];
            providerRows.forEach(row => {
                const name = row.querySelector('.prov-name').value;
                const vlan = row.querySelector('.prov-vlan').value;
                const contact = row.querySelector('.prov-contact').value;

                if (name.trim() !== "") {
                    providersList.push({ name, vlan, contact });
                }
            });

            const data = {
                name: document.getElementById('p_name').value,
                excelLink: document.getElementById('p_excel').value,
                rbIp: document.getElementById('p_ip').value,
                rbUser: document.getElementById('p_user').value,
                rbPort: document.getElementById('p_port').value,
                rbWinboxPort: document.getElementById('p_winbox').value,
                rbPassword: document.getElementById('p_pass').value,
                providers: providersList
            };

            const url = editingProjectId ? `/api/projects/${editingProjectId}` : '/api/projects';
            const method = editingProjectId ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    fecharModal();
                    carregarProjetos();
                } else {
                    const err = await res.json();
                    alert("Erro: " + err.error);
                }
            } catch (error) {
                console.error(error);
                alert("Erro de conex√£o ao salvar.");
            }
        });
    </script>
</body>

</html>