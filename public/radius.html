<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Radius (VM)</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { display: none; }
    </style>
</head>
<body>

    <div class="card admin-mode" style="margin-top: 20px;">
        
        <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <h2>üì° Gest√£o Radius</h2>
        </div>

        <form id="radiusForm" class="admin-form-grid" style="align-items: flex-end;">
            <div>
                <label>Usu√°rio</label>
                <input type="text" id="r_username" placeholder="Ex: adalberto.alecrim" required>
            </div>
            <div>
                <label>Senha</label>
                <input type="text" id="r_password" placeholder="Senha de conex√£o" required>
            </div>
            
            <div>
                <label>Grupo</label>
                <select id="r_group" required>
                    <option value="" disabled selected>Carregando op√ß√µes...</option>
                </select>
            </div>
            
            <button type="submit" class="btn-success" style="height: 42px; margin-bottom: 2px;">
                <span id="btnText">Criar Acesso</span>
            </button>
        </form>

        <div class="table-responsive">
            <table id="radiusTable">
                <thead>
                    <tr>
                        <th>Usu√°rio</th>
                        <th>Senha (radcheck)</th>
                        <th>Grupo (radusergroup)</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4" align="center">Carregando dados da VM...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="navbar.js"></script>

    <script>
        const token = localStorage.getItem('token');
        const myRole = localStorage.getItem('userRole'); 
        const mySector = localStorage.getItem('userSector'); // <--- Pega o setor
        let editingUsername = null;

        // 1. SEGURAN√áA DE LOGIN
        if (!token) { 
            window.location.href = 'login.html'; 
        }
        // 2. SEGURAN√áA DE CARGO E SETOR
        // Se n√£o for (Master OU Full) OU se o setor n√£o for SUPORTE_N2...
        else if (
            (myRole !== 'ADMIN_MASTER' && myRole !== 'FULL') || 
            mySector !== 'SUPORTE_N2'
        ) {
            alert("‚õî Acesso Negado!\nEsta ferramenta √© exclusiva para Gestores do SUPORTE_N2.");
            window.location.href = 'menu.html';
        }
        else {
            document.body.style.display = 'flex';
            criarNavbar('Gest√£o Radius');
            carregarOpcoes(); 
            carregarRadius();
        }

       // --- CARREGAR OP√á√ïES DO SELECT (CORRIGIDO: PUXA DA VM) ---
        async function carregarOpcoes() {
            try {
                // Agora chama a rota que busca os grupos REAIS do Radius na VM
                const res = await fetch('/api/radius/groups', { headers: { 'Authorization': `Bearer ${token}` } });
                
                const select = document.getElementById('r_group');
                select.innerHTML = '<option value="" disabled selected>Selecione o Plano/Grupo</option>';

                if (res.ok) {
                    const lista = await res.json();
                    
                    if (lista.length === 0) {
                        // Se n√£o tiver nenhum grupo l√°, adiciona op√ß√£o manual ou aviso
                        select.innerHTML += `<option disabled>Nenhum grupo encontrado na VM</option>`;
                    }

                    // Preenche com os dados da VM (MT_FULL, N2, etc)
                    lista.forEach(item => {
                        // O banco retorna { groupname: 'MT_FULL' }
                        if(item.groupname) {
                            select.innerHTML += `<option value="${item.groupname}">${item.groupname}</option>`;
                        }
                    });
                } else {
                    console.error("Erro ao buscar grupos do Radius");
                    select.innerHTML += `<option disabled>Erro ao carregar</option>`;
                }
            } catch (err) { console.error("Erro de conex√£o", err); }
        }

        // --- LISTAR RADIUS ---
        async function carregarRadius() {
            try {
                const res = await fetch('/api/radius/users', { headers: { 'Authorization': `Bearer ${token}` } });
                const users = await res.json();
                const tbody = document.querySelector('#radiusTable tbody');
                tbody.innerHTML = '';

                if(users.error) {
                    tbody.innerHTML = `<tr><td colspan="4" align="center" style="color:red">Erro: ${users.error}</td></tr>`;
                    return;
                }

                if(users.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" align="center">Nenhum usu√°rio encontrado na VM.</td></tr>`;
                    return;
                }

                users.forEach(u => {
                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${u.username}</strong></td>
                            <td>${u.password}</td>
                            <td><span class="tag-badge">${u.groupname || 'Sem Grupo'}</span></td>
                            <td>
                                <button class="action-btn btn-edit" onclick="prepararEdicao('${u.username}', '${u.password}', '${u.groupname}')">‚úèÔ∏è</button>
                                <button class="action-btn btn-del" onclick="excluirRadius('${u.username}')">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            } catch(e) {
                document.querySelector('#radiusTable tbody').innerHTML = `<tr><td colspan="4" align="center" style="color:red">Falha na conex√£o com a VM.</td></tr>`;
            }
        }

        // --- CRIAR / EDITAR ---
        document.getElementById('radiusForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                username: document.getElementById('r_username').value,
                password: document.getElementById('r_password').value,
                groupname: document.getElementById('r_group').value
            };

            let url = '/api/radius/users';
            let method = 'POST';

            if (editingUsername) {
                url = `/api/radius/users/${editingUsername}`;
                method = 'PUT';
            }

            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(data)
            });

            const result = await res.json();
            
            if (res.ok) {
                alert(result.message);
                limparForm();
                carregarRadius();
            } else {
                alert("Erro: " + result.error);
            }
        });

        // --- PREPARAR EDI√á√ÉO ---
        function prepararEdicao(user, pass, group) {
            editingUsername = user;
            document.getElementById('r_username').value = user;
            document.getElementById('r_username').disabled = true; 
            document.getElementById('r_password').value = pass;
            
            // Seleciona o item correto no dropdown
            const select = document.getElementById('r_group');
            if (group && group !== 'null' && group !== 'undefined') {
                select.value = group;
            } else {
                select.value = ""; // Reseta se n√£o tiver grupo
            }
            
            document.getElementById('btnText').innerText = "Salvar Altera√ß√µes";
            document.querySelector('.btn-success').style.background = "#e67e22";
        }

        function limparForm() {
            editingUsername = null;
            document.getElementById('radiusForm').reset();
            document.getElementById('r_username').disabled = false;
            document.getElementById('btnText').innerText = "Criar Acesso";
            document.querySelector('.btn-success').style.background = "";
            document.getElementById('r_group').value = ""; // Reseta o select
        }

        // --- EXCLUIR ---
        async function excluirRadius(username) {
            if(!confirm(`Tem certeza que deseja apagar o usu√°rio ${username} da VM?`)) return;

            const res = await fetch(`/api/radius/users/${username}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.ok) {
                alert("Usu√°rio removido!");
                carregarRadius();
            } else {
                alert("Erro ao excluir.");
            }
        }
    </script>
</body>
</html>