<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Radius (VM)</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            display: none;
        }

        /* --- CORRE√á√ïES VISUAIS --- */
        input::-ms-reveal,
        input::-ms-clear {
            display: none !important;
        }

        /* --- ESTILO DO FORMUL√ÅRIO (INPUT GROUP) --- */
        .input-group {
            display: flex;
            align-items: stretch;
            width: 100%;
            position: relative;
        }

        .input-group input {
            border-top-right-radius: 0 !important;
            border-bottom-right-radius: 0 !important;
            border-right: none !important;
            flex: 1;
            margin: 0 !important;
        }

        .btn-addon {
            width: 45px !important;
            background-color: #fcfcfc;
            border: 1px solid #bdc3c7;
            border-left: none;
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            padding: 0;
            margin: 0;
        }

        .btn-addon:hover {
            background-color: #ecf0f1;
            color: #333;
        }

        /* --- BARRAS DE PESQUISA --- */
        .search-container {
            width: 100%;
            margin-bottom: 15px;
            margin-top: 25px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-size: 1rem;
            color: #555;
            background-color: #fcfcfc;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 15px center;
            padding-left: 45px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #3498db;
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        /* --- TABELA E SENHA --- */
        .cell-password {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0 5px;
            height: 35px;
            width: 100%;
        }

        .table-input-password {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
            padding: 0;
            margin: 0;
            font-family: monospace;
            font-size: 1.1rem;
            color: #000 !important;
            width: 100% !important;
            height: 100%;
            cursor: text;
            letter-spacing: 2px;
        }

        .btn-eye-table {
            width: 30px !important;
            height: 30px !important;
            background: none !important;
            border: none !important;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
            flex-shrink: 0;
        }

        .btn-eye-table:hover {
            color: #000;
            transform: scale(1.1);
        }

        /* --- ESTILOS PARA LOGS E CONTROLES --- */
        .section-header {
            margin-top: 40px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #34495e;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .log-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-refresh {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
            width: auto;
        }

        .btn-refresh:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #555;
        }

        .toggle-switch {
            position: relative;
            width: 34px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #27ae60;
        }

        input:checked+.slider:before {
            transform: translateX(14px);
        }

        /* --- CORRE√á√ÉO DOS BADGES --- */
        .log-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .log-accept {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .log-reject {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .log-other {
            background-color: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }
    </style>
</head>

<body>

    <div class="card admin-mode" style="margin-top: 20px; margin-bottom: 50px;">

        <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <h2>üì° Gest√£o Radius</h2>
            <p style="color:#666; font-size: 0.9rem;">Gerenciamento de <b>Usu√°rios</b> e <b>Logs de Acesso</b></p>
        </div>

        <form id="radiusForm" class="admin-form-grid"
            style="align-items: flex-end; grid-template-columns: 1fr 1fr 1fr 1fr auto;" autocomplete="off">

            <input type="text" style="display:none">
            <input type="password" style="display:none">
            <div>
                <label>Usu√°rio</label>
                <input type="text" id="r_username" placeholder="Ex: cliente.silva" required autocomplete="new-password">
            </div>
            <div>
                <label>Senha</label>
                <div class="input-group">
                    <input type="password" id="r_password" placeholder="Senha" required autocomplete="new-password">
                    <button type="button" onclick="toggleFormPassword()" class="btn-addon" tabindex="-1"
                        title="Mostrar Senha">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path
                                d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 12.332 10.119 13.5 8 13.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z" />
                            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5z" />
                        </svg>
                    </button>
                </div>
            </div>
            <div>
                <label>Setor (Prio. 1)</label>
                <select id="r_setor" required>
                    <option value="" disabled selected>Carregando...</option>
                </select>
            </div>
            <div>
                <label>Acesso (Prio. 2)</label>
                <select id="r_acesso" required>
                    <option value="" disabled selected>Carregando...</option>
                </select>
            </div>
            <button type="submit" class="btn-success" style="height: 40px; margin-bottom: 0px;">
                <span id="btnText">Criar</span>
            </button>
        </form>

        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="üîç Pesquisar usu√°rio na lista..."
                onkeyup="filtrarTabela()">
        </div>

        <div class="table-responsive" style="max-height: 400px;">
            <table id="radiusTable">
                <thead>
                    <tr>
                        <th style="width: 25%;">Usu√°rio</th>
                        <th style="width: 300px;">Senha</th>
                        <th style="width: 10%;">Setor (P1)</th>
                        <th style="width: 10%;">Acesso (P2)</th>
                        <th style="width: 100px;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" align="center">Carregando dados...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section-header">
            <h3>üìú Hist√≥rico de Conex√µes (Logs)</h3>
            <div class="log-controls">
                <div class="toggle-container">
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoRefreshCheck" onchange="toggleAutoRefresh()">
                        <span class="slider"></span>
                    </label>
                    <span>Auto (5s)</span>
                </div>
                <button class="btn-refresh" onclick="carregarLogs()">
                    ‚Üª Atualizar
                </button>
            </div>
        </div>

        <div class="search-container" style="margin-top: 10px;">
            <input type="text" id="searchLogsInput" class="search-input"
                placeholder="üîç Pesquisar por nome, data (ex: 20/01), hora ou status..." onkeyup="filtrarLogs()">
        </div>

        <div class="table-responsive" style="max-height: 500px;">
            <table id="logsTable">
                <thead>
                    <tr>
                        <th style="width: 160px;">Data/Hora</th>
                        <th style="width: 15%;">Usu√°rio</th>
                        <th>Indentify da RB</th>
                        <th style="width: 130px;">IP da RB</th>
                        <th style="width: 130px;">IP de Origem</th>
                        <th style="width: 140px; text-align:center;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6" align="center">Aguardando carregamento...</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <script src="navbar.js"></script>

    <script>
        const token = localStorage.getItem('token');
        const myRole = localStorage.getItem('userRole');
        const mySector = localStorage.getItem('userSector');

        let editingUsername = null;
        let globalUsersList = [];
        let globalLogsList = [];
        let autoRefreshInterval = null;

        if (!token) { window.location.href = 'login.html'; }
        else if ((myRole !== 'ADMIN_MASTER' && myRole !== 'FULL') || mySector !== 'SUPORTE_N2') {
            alert("‚õî Acesso Negado!\nExclusivo para Gestores do SUPORTE_N2.");
            window.location.href = 'menu.html';
        }
        else {
            document.body.style.display = 'flex';
            criarNavbar('Gest√£o Radius');
            iniciarTela();
        }

        async function iniciarTela() {
            // Carrega dropdowns antes de tudo para garantir que a edi√ß√£o funcione
            await carregarListasDropdown();
            await carregarRadius();
            carregarLogs();
        }

        function toggleFormPassword() {
            const input = document.getElementById('r_password');
            input.type = input.type === "password" ? "text" : "password";
        }
        function toggleTablePassword(id) {
            const input = document.getElementById(id);
            input.type = input.type === "password" ? "text" : "password";
        }

        function toggleAutoRefresh() {
            const check = document.getElementById('autoRefreshCheck');
            if (check.checked) {
                autoRefreshInterval = setInterval(() => { carregarLogs(true); }, 5000);
            } else {
                clearInterval(autoRefreshInterval);
            }
        }

        async function carregarListasDropdown() {
            try {
                const res = await fetch('/api/radius/options', { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    const dados = await res.json();
                    const selSetor = document.getElementById('r_setor');
                    const selAcesso = document.getElementById('r_acesso');
                    selSetor.innerHTML = '<option value="" disabled selected>Selecione Setor</option>';
                    selAcesso.innerHTML = '<option value="" disabled selected>Selecione Acesso</option>';

                    dados.setores.forEach(i => selSetor.innerHTML += `<option value="${i.groupname}">${i.groupname}</option>`);
                    dados.acessos.forEach(i => selAcesso.innerHTML += `<option value="${i.groupname}">${i.groupname}</option>`);
                }
            } catch (err) { console.error(err); }
        }

        async function carregarRadius() {
            try {
                const res = await fetch('/api/radius/users', { headers: { 'Authorization': `Bearer ${token}` } });
                const users = await res.json();

                if (users.error) {
                    document.querySelector('#radiusTable tbody').innerHTML = `<tr><td colspan="5" align="center" style="color:red">Erro: ${users.error}</td></tr>`;
                    return;
                }
                globalUsersList = users;
                renderizarTabela(globalUsersList);
            } catch (e) {
                document.querySelector('#radiusTable tbody').innerHTML = `<tr><td colspan="5" align="center" style="color:red">Falha na conex√£o com a VM.</td></tr>`;
            }
        }

        function renderizarTabela(lista) {
            const tbody = document.querySelector('#radiusTable tbody');
            tbody.innerHTML = '';
            if (lista.length === 0) { tbody.innerHTML = `<tr><td colspan="5" align="center">Nenhum usu√°rio encontrado.</td></tr>`; return; }

            lista.forEach((u, i) => {
                const passId = `pass_field_${Math.random().toString(36).substr(2, 9)}`;
                const eyeIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 12.332 10.119 13.5 8 13.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5z"/></svg>`;

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${u.username}</strong></td>
                        <td>
                            <div class="cell-password">
                                <input type="password" id="${passId}" value="${u.password}" class="table-input-password" readonly>
                                <button class="btn-eye-table" onclick="toggleTablePassword('${passId}')" title="Ver Senha" tabindex="-1">${eyeIcon}</button>
                            </div>
                        </td>
                        <td><span class="tag-badge" style="background:#e8f8f5; color:#27ae60;">${u.setor || '-'}</span></td>
                        <td><span class="tag-badge" style="background:#fef9e7; color:#f1c40f;">${u.acesso || '-'}</span></td>
                        <td>
                            <button class="action-btn btn-edit" onclick="abrirEdicao('${u.username}')">‚úèÔ∏è</button>
                            <button class="action-btn btn-del" onclick="excluirUsuario('${u.username}')">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
        }

        // --- SUBSTITUA A FUN√á√ÉO abrirEdicao ---
        function abrirEdicao(username) {
            const user = globalUsersList.find(u => u.username === username);
            if (!user) return;

            editingUsername = user.username; // Guarda o nome ANTIGO para saber quem editar

            const userInput = document.getElementById('r_username');
            const passInput = document.getElementById('r_password');

            // Preenche e DESTRAVA o campo
            userInput.value = user.username;
            userInput.disabled = false; // <--- AQUI ESTAVA O BLOQUEIO, AGORA √â FALSE

            passInput.value = user.password;
            passInput.type = "text";

            if (user.setor) document.getElementById('r_setor').value = user.setor;
            if (user.acesso) document.getElementById('r_acesso').value = user.acesso;

            document.getElementById('btnText').innerText = "Salvar Altera√ß√µes";
            document.querySelector('.btn-success').style.background = "#e67e22";

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- SUBSTITUA O EVENT LISTENER DO FORMUL√ÅRIO ---
        document.getElementById('radiusForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Pega os valores atuais dos campos
            const newUsername = document.getElementById('r_username').value;
            const password = document.getElementById('r_password').value;
            const setor = document.getElementById('r_setor').value;
            const acesso = document.getElementById('r_acesso').value;

            const data = {
                newUsername: newUsername, // Envia o novo nome digitado
                password: password,
                setor: setor,
                acesso: acesso
            };

            // Se estiver editando, a URL usa o editingUsername (nome ANTIGO)
            let url = editingUsername
                ? `/api/radius/users/${encodeURIComponent(editingUsername)}`
                : '/api/radius/users';

            // Se n√£o estiver editando, o corpo precisa ter 'username' para o CREATE
            if (!editingUsername) {
                data.username = newUsername;
            }

            let method = editingUsername ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (res.ok) {
                    alert(result.message);
                    limparForm();
                    carregarRadius();
                } else {
                    alert("Erro: " + result.error);
                }
            } catch (error) {
                alert("Erro de conex√£o ao salvar.");
            }
        });

        async function excluirUsuario(username) {
            if (!confirm(`Tem certeza que deseja apagar ${username}?`)) return;
            try {
                const res = await fetch(`/api/radius/users/${encodeURIComponent(username)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    alert("Removido!");
                    carregarRadius();
                } else {
                    const e = await res.json();
                    alert("Erro: " + e.error);
                }
            } catch (e) {
                alert("Erro ao excluir.");
            }
        }

        function limparForm() {
            editingUsername = null;
            document.getElementById('radiusForm').reset();
            const userInput = document.getElementById('r_username');
            userInput.disabled = false;

            const passInput = document.getElementById('r_password');
            passInput.type = "password";

            document.getElementById('btnText').innerText = "Criar";
            document.querySelector('.btn-success').style.background = "";
            document.getElementById('r_setor').value = "";
            document.getElementById('r_acesso').value = "";
        }

        // Fun√ß√µes de Log
        async function carregarLogs(silencioso = false) {
            try {
                if (!silencioso && globalLogsList.length === 0) {
                    document.querySelector('#logsTable tbody').innerHTML = `<tr><td colspan="6" align="center">Atualizando logs...</td></tr>`;
                }
                const res = await fetch('/api/radius/logs', { headers: { 'Authorization': `Bearer ${token}` } });
                const logs = await res.json();
                if (logs.error) {
                    if (!silencioso) document.querySelector('#logsTable tbody').innerHTML = `<tr><td colspan="6" align="center" style="color:red">Erro: ${logs.error}</td></tr>`;
                    return;
                }
                globalLogsList = logs;
                filtrarLogs();
            } catch (e) {
                if (!silencioso) document.querySelector('#logsTable tbody').innerHTML = `<tr><td colspan="6" align="center" style="color:red">Erro na conex√£o.</td></tr>`;
            }
        }

        function renderizarLogs(lista) {
            const tbody = document.querySelector('#logsTable tbody');
            tbody.innerHTML = '';
            if (lista.length === 0) { tbody.innerHTML = `<tr><td colspan="6" align="center">Nenhum log encontrado.</td></tr>`; return; }
            lista.forEach(log => {
                const dataTexto = log.authdate ? new Date(log.authdate).toLocaleString('pt-BR') : '-';
                let statusClass = 'log-other';
                if (log.reply && log.reply.toLowerCase().includes('accept')) statusClass = 'log-accept';
                else if (log.reply && log.reply.toLowerCase().includes('reject')) statusClass = 'log-reject';
                tbody.innerHTML += `<tr><td style="font-size: 0.85rem; color:#555;">${dataTexto}</td><td><strong>${log.username || '-'}</strong></td><td><small>${log.nas_identifier || '-'}</small></td><td>${log.nas_ip || '-'}</td><td>${log.src_ip || '-'}</td><td style="text-align:center;"><span class="log-badge ${statusClass}">${log.reply || 'Desconhecido'}</span></td></tr>`;
            });
        }

        function filtrarTabela() {
            const termo = document.getElementById('searchInput').value.toLowerCase();
            const listaFiltrada = globalUsersList.filter(user => user.username.toLowerCase().includes(termo) || (user.setor && user.setor.toLowerCase().includes(termo)));
            renderizarTabela(listaFiltrada);
        }

        function filtrarLogs() {
            const termo = document.getElementById('searchLogsInput').value.toLowerCase();
            const listaFiltrada = globalLogsList.filter(log => {
                const matchNome = log.username && log.username.toLowerCase().includes(termo);
                const dataTexto = log.authdate ? new Date(log.authdate).toLocaleString('pt-BR') : '';
                const matchData = dataTexto.includes(termo);
                const matchStatus = log.reply && log.reply.toLowerCase().includes(termo);
                return matchNome || matchData || matchStatus;
            });
            renderizarLogs(listaFiltrada);
        }
    </script>
</body>

</html>